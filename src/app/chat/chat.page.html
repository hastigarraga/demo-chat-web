<div class="shell" [class.collapsed]="sidebarCollapsed">
  <aside class="sidebar">
    <div class="side-header">
      <div class="side-actions">
        <button type="button" class="btn-new" (click)="newThread()">New chat</button>
        <button type="button"
                class="btn-hide"
                title="Ocultar barra lateral"
                aria-label="Ocultar barra lateral"
                (click)="toggleSidebar()">❮</button>
      </div>
    </div>

    <div class="threads-scroll" (scroll)="closeMenus()">
      <ul class="threads">
        <li *ngFor="let t of threads; trackBy: trackByIdx"
            [class.active]="(t._id||t.id) === (current?._id || current?.id)"
            (click)="select(t)">
          <div class="t-title">{{ titleOf(t) }}</div>
          <div class="t-meta">{{ (t.updatedAt || t.createdAt) | localTz:'dd/MM/yyyy HH:mm' }}</div>

          <button type="button"
                  class="btn-ellipsis"
                  (click)="openMenu($event, t)">
            ⋯
          </button>
        </li>
      </ul>
    </div>

    <div class="account" (click)="toggleAccountMenu($event)">
      <div class="avatar">{{ userInitial }}</div>
      <div class="who">
        <div class="name">{{ userName }}</div>
        <div class="email">{{ userEmail }}</div>
      </div>
    </div>

    <div class="account-menu" *ngIf="accountMenuOpen" (click)="$event.stopPropagation()">
      <ng-container *ngIf="gwsConnected; else notConnected">
        <button type="button" class="mi" disabled>
          Conectado como {{ gwsEmail || "—" }}
        </button>
        <button type="button" class="mi" (click)="disconnectWorkspace()" [disabled]="gwsBusy">
          Disconnect Google
        </button>
      </ng-container>

      <ng-template #notConnected>
        <button type="button" class="mi" (click)="connectWorkspace('drive')" [disabled]="gwsBusy">
          Connect Google
        </button>
      </ng-template>

      <button type="button" class="mi" (click)="logout()">Log out</button>
    </div>

  </aside>

  <section class="main">
    <button type="button"
            class="toggle-sidebar"
            *ngIf="sidebarCollapsed"
            (click)="toggleSidebar()"
            title="Abrir barra lateral"
            aria-label="Abrir barra lateral">❯</button>

    <div class="messages" id="messages" (scroll)="closeMenus()" (click)="closeMenus()">
      <div *ngFor="let m of messages; trackBy: trackByIdx"
           class="msg"
           [class.user]="m.role==='user'"
           [class.assistant]="m.role==='assistant'">
        <div class="bubble">{{ m.content }}</div>
      </div>
      <div #bottom></div>
    </div>

    <div class="composer">
      <input type="text"
             [(ngModel)]="input"
             (keydown.enter)="send(); $event.preventDefault()"
             placeholder="Escribe tu mensaje…" />
      <button type="button" (click)="send()" [disabled]="sending">Send</button>
    </div>
  </section>
</div>

<div class="ctx-menu"
     *ngIf="menuOpenId"
     [ngStyle]="{ top: menuTop + 'px', left: menuLeft + 'px' }"
     (click)="$event.stopPropagation()">
  <button type="button" class="mi" (click)="renameThread(menuThreadRef); closeMenus()">
    Edit
  </button>
  <button type="button" class="mi danger" (click)="removeThread(menuThreadRef); closeMenus()">
    Delete
  </button>
</div>
