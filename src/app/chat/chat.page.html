<div class="shell" [class.collapsed]="sidebarCollapsed">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="side-header">
      <div class="side-actions">
        <button type="button" class="btn-new" (click)="newThread()">
          New chat
        </button>
        <button
          type="button"
          class="btn-hide"
          title="Hide sidebar"
          aria-label="Hide sidebar"
          (click)="toggleSidebar()"
        >
          ❮
        </button>
      </div>
    </div>

    <div class="threads-scroll" (scroll)="closeMenus()">
      <ul class="threads">
        <li
          *ngFor="let t of threads"
          (click)="select(t)"
          [class.active]="(current?._id || current?.id) === (t._id || t.id)"
        >
          <button type="button" class="thread-row">
            <span class="title">{{ t | threadTitle }}</span>
            <span class="meta">
              <span class="time">{{ t.updatedAt | localTzDate }}</span>
            </span>
            <button
              type="button"
              class="btn-ellipsis"
              (click)="openMenu($event, t)"
              title="Options"
            >
              ⋮
            </button>
          </button>
        </li>
      </ul>

      <div class="empty" *ngIf="!threads?.length">
        <p>No chats yet.</p>
        <button type="button" class="btn-secondary" (click)="newThread()">
          Start a chat
        </button>
      </div>
    </div>

    <!-- Perfil abajo -->
    <div class="account" (click)="toggleAccountMenu($event)">
      <div class="avatar">{{ userInitial }}</div>
      <div class="who">
        <div class="name">{{ userName || 'User' }}</div>
        <div class="email">{{ userEmail }}</div>
      </div>
    </div>

    <!-- Menú de cuenta (Connect + Logout) -->
    <div
      class="account-menu"
      *ngIf="accountMenuOpen"
      (click)="$event.stopPropagation()"
    >
      <button type="button" class="mi" (click)="connectWorkspace()">
        Connect Google Workspace
      </button>
      <button type="button" class="mi" (click)="logout()">
        Log out
      </button>
    </div>
  </aside>

  <!-- MAIN -->
  <section class="main">
    <!-- botón flotante para mostrar sidebar cuando está colapsada -->
    <button
      type="button"
      class="toggle-sidebar"
      *ngIf="sidebarCollapsed"
      (click)="toggleSidebar()"
      title="Show sidebar"
      aria-label="Show sidebar"
    >
      ☰
    </button>

    <div class="messages" (scroll)="closeMenus()" (click)="closeMenus()">
      <div
        *ngFor="let m of messages; trackBy: trackByIdx"
        class="message"
        [class.user]="m.role === 'user'"
        [class.assistant]="m.role === 'assistant'"
      >
        <div class="bubble">
          <pre>{{ m.content }}</pre>
        </div>
      </div>

      <div #bottom></div>
    </div>

    <form class="composer" (ngSubmit)="send()">
      <textarea
        [(ngModel)]="input"
        name="input"
        rows="2"
        placeholder="Type your message..."
        [disabled]="sending"
      ></textarea>

      <button type="submit" [disabled]="sending || !input.trim()">
        {{ sending ? "Sending…" : "Send" }}
      </button>
    </form>
  </section>
</div>

<!-- Menú contextual de hilos (fixed, fuera del sidebar) -->
<div
  class="ctx-menu"
  *ngIf="menuOpenId"
  [ngStyle]="{ top: menuTop + 'px', left: menuLeft + 'px' }"
  (click)="$event.stopPropagation()"
>
  <button
    type="button"
    class="mi"
    (click)="renameThread(menuThreadRef); closeMenus()"
  >
    Edit
  </button>
  <button
    type="button"
    class="mi danger"
    (click)="removeThread(menuThreadRef); closeMenus()"
  >
    Delete
  </button>
</div>
