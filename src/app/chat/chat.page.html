<div class="shell" [class.collapsed]="sidebarCollapsed">
  <aside class="sidebar">
    <div class="side-header">
      <div class="side-actions">
        <button type="button" class="btn-new" (click)="newThread()">
          New chat
        </button>

        <button
          type="button"
          class="btn-hide"
          title="Hide sidebar"
          aria-label="Hide sidebar"
          (click)="toggleSidebar()"
        >
          ❮
        </button>
      </div>

      <!-- Chip de usuario / menú de cuenta -->
      <button
        type="button"
        class="user-chip"
        (click)="toggleAccountMenu($event)"
      >
        <div class="avatar">
          {{
            (userName || userEmail || "U")
              .charAt(0)
              .toUpperCase()
          }}
        </div>
        <div class="user-meta">
          <div class="user-name">
            {{ userName || "User" }}
          </div>
          <div class="user-email" *ngIf="userEmail">
            {{ userEmail }}
          </div>
        </div>
      </button>
    </div>

    <div class="threads-scroll" (scroll)="closeMenus()">
      <ul class="threads">
        <li
          *ngFor="let t of threads; trackBy: trackByThread"
          [class.active]="
            current &&
            (current._id || current.id) === (t._id || t.id)
          "
          (click)="openThread(t)"
        >
          <button type="button" class="thread-main">
            <div class="thread-title">
              {{ t | threadTitle }}
            </div>
          </button>

          <button
            type="button"
            class="btn-ellipsis"
            (click)="openMenu($event, t)"
            title="More options"
          >
            ⋮
          </button>
        </li>
      </ul>

      <div class="empty" *ngIf="!threads?.length">
        <p>No chats yet.</p>
        <button type="button" class="btn-secondary" (click)="newThread()">
          Start a chat
        </button>
      </div>
    </div>

    <!-- Menú de cuenta: acá van Connect + Logout -->
    <div
      class="account-menu"
      *ngIf="accountMenuOpen"
      (click)="$event.stopPropagation()"
    >
      <button type="button" class="mi" (click)="connectWorkspace()">
        Connect Google Workspace
      </button>
      <button type="button" class="mi" (click)="logout()">
        Log out
      </button>
    </div>
  </aside>

  <section class="main">
    <!-- botón flotante para reabrir sidebar cuando está colapsada -->
    <button
      type="button"
      class="toggle-sidebar"
      *ngIf="sidebarCollapsed"
      (click)="toggleSidebar()"
      title="Show sidebar"
      aria-label="Show sidebar"
    >
      ☰
    </button>

    <div class="main-inner" *ngIf="current; else emptyState">
      <header class="chat-header">
        <h1>{{ current | threadTitle }}</h1>
      </header>

      <div class="messages" (scroll)="closeMenus()">
        <div
          *ngFor="let m of messages; trackBy: trackByMessage"
          class="msg"
          [class.user]="m.role === 'user'"
          [class.assistant]="m.role === 'assistant'"
        >
          <div class="msg-meta">
            <span class="role">{{ m.role }}</span>
            <span class="time">{{ m.createdAt | localTzDate }}</span>
          </div>
          <div class="msg-body">
            {{ m.content }}
          </div>
        </div>

        <div #bottom></div>
      </div>

      <form class="composer" (ngSubmit)="send()">
        <textarea
          [(ngModel)]="input"
          name="input"
          rows="1"
          placeholder="Send a message..."
          (keydown.enter)="
            !$event.shiftKey && (send(); $event.preventDefault())
          "
        ></textarea>

        <button type="submit" [disabled]="sending || !input.trim()">
          {{ sending ? "Sending…" : "Send" }}
        </button>
      </form>
    </div>

    <ng-template #emptyState>
      <div class="empty-main">
        <h1>Welcome</h1>
        <p>Start a new chat to begin talking with the assistant.</p>
        <button type="button" class="btn-primary" (click)="newThread()">
          New chat
        </button>
      </div>
    </ng-template>
  </section>
</div>

<!-- Menú contextual de hilos (fixed) -->
<div
  class="ctx-menu"
  *ngIf="menuOpenId"
  [ngStyle]="{ top: menuTop + 'px', left: menuLeft + 'px' }"
  (click)="$event.stopPropagation()"
>
  <button
    type="button"
    class="mi"
    (click)="renameThread(menuThreadRef); closeMenus()"
  >
    Edit
  </button>
  <button
    type="button"
    class="mi danger"
    (click)="removeThread(menuThreadRef); closeMenus()"
  >
    Delete
  </button>
</div>
