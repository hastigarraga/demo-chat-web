<div class="shell" [class.collapsed]="sidebarCollapsed">
  <aside class="sidebar">
    <div class="sidebar-top">
      <button type="button" class="btn-icon" (click)="toggleSidebar()" aria-label="Toggle sidebar">
        <span class="icon">≡</span>
      </button>

      <div class="brand">
        <div class="brand-title">demo-chat</div>
      </div>

      <div class="actions">
        <button type="button" class="btn-new" (click)="newThread()">New</button>
      </div>
    </div>

    <div class="thread-list">
      <button
        type="button"
        class="thread"
        *ngFor="let t of threads"
        [class.active]="(t?._id||t?.id) === (current?._id||current?.id)"
        (click)="openThread(t,true)"
      >
        <div class="thread-title">{{ t.title | threadTitle }}</div>

        <button
          type="button"
          class="btn-ellipsis"
          (click)="openMenu($event,t)"
          aria-label="Thread menu"
          title="Options"
        >
          ⋮
        </button>
      </button>
    </div>

    <!-- menu contextual fixed -->
    <div
      class="ctx-menu"
      *ngIf="menuOpenId"
      [style.top.px]="menuTop"
      [style.left.px]="menuLeft"
      (click)="$event.stopPropagation()"
    >
      <button type="button" class="ctx-item" (click)="renameThread(menuThreadRef)">Rename</button>
      <div class="ctx-sep"></div>
      <button type="button" class="ctx-item danger" (click)="deleteThread(menuThreadRef)">Delete</button>
    </div>

    <div class="sidebar-bottom">
      <button type="button" class="account" (click)="toggleAccountMenu()">
        <div class="avatar">{{ userInitial }}</div>
        <div class="account-meta">
          <div class="account-name">{{ userName || "User" }}</div>
          <div class="account-email">{{ userEmail || "" }}</div>
        </div>
        <div class="chev">▾</div>
      </button>

      <div class="account-menu" *ngIf="accountMenuOpen" (click)="$event.stopPropagation()">
        <button type="button" class="acc-item" (click)="connectWorkspace()">Connect Google</button>
        <button type="button" class="acc-item" (click)="logout()">Logout</button>
      </div>
    </div>
  </aside>

  <main class="main">
    <div class="chat">
      <div class="messages" #messagesEl>
        <div class="msg" *ngFor="let m of messages; trackBy: trackByIdx">
          <div class="bubble" [class.user]="m.role==='user'">
            <div class="meta">
              <span class="role">{{ m.role }}</span>
              <span class="time">{{ m.createdAt | localTzDate }}</span>
            </div>
            <div class="text">{{ m.content }}</div>
          </div>
        </div>
        <div #bottom></div>
      </div>

      <div class="composer">
        <input
          type="text"
          [(ngModel)]="input"
          (keydown.enter)="send()"
          placeholder="Message…"
        />
        <button type="button" class="btn-send" (click)="send()" [disabled]="sending || !input.trim()">
          {{ sending ? "Sending…" : "Send" }}
        </button>
      </div>
    </div>
  </main>
</div>
