<div class="layout">

  <aside class="sidebar" [class.collapsed]="sidebarCollapsed">

    <div class="brand">
      <button type="button" class="toggle" (click)="toggleSidebar()" aria-label="Toggle sidebar">☰</button>
      <div class="logo">demo-chat</div>
      <button type="button" class="new" (click)="newThread()">New</button>
    </div>

    <div class="threads">
      <div class="t"
           *ngFor="let t of threads"
           [class.active]="(t?._id||t?.id) === (current?._id||current?.id)"
           (click)="openThread(t,true)">
        <div class="title">{{ titleOf(t) }}</div>
        <button type="button" class="kebab" (click)="openMenu($event,t)">⋮</button>

        <div class="ctx-menu"
             *ngIf="menuOpenId === (t?._id||t?.id)"
             [style.top.px]="menuTop"
             [style.left.px]="menuLeft"
             (click)="$event.stopPropagation()">
          <button (click)="renameThreadPrompt(t)">Rename</button>
          <button class="danger" (click)="deleteThread(t)">Delete</button>
        </div>
      </div>
    </div>

    <!-- Perfil abajo -->
    <div class="account" (click)="toggleAccountMenu($event)">
      <div class="avatar">{{ userInitial }}</div>
      <div class="who">
        <div class="name">{{ userName }}</div>
        <div class="email">{{ userEmail }}</div>
      </div>
    </div>

    <!-- Popover de cuenta -->
    <div class="account-menu" *ngIf="accountMenuOpen" (click)="$event.stopPropagation()">
      <button type="button" class="mi" *ngIf="!gwsConnected" (click)="connectWorkspace('drive')" [disabled]="gwsLoading">
        {{ gwsLoading ? "Conectando…" : "Connect Google" }}
      </button>
      <div class="mi status" *ngIf="gwsConnected">Conectado como <strong>{{ gwsEmail }}</strong></div>
      <button type="button" class="mi" *ngIf="gwsConnected" (click)="disconnectWorkspace()">Disconnect</button>

      <button type="button" class="mi" (click)="logout()">Log out</button>
    </div>

  </aside>

  <section class="main">
    <!-- botón flotante para reabrir sidebar cuando está oculto -->
    <button type="button"
            class="toggle-sidebar"
            *ngIf="sidebarCollapsed"
            (click)="toggleSidebar()"
            title="Abrir barra lateral"
            aria-label="Abrir barra lateral">❯</button>

    <div class="messages">
      <div class="msg" *ngFor="let m of messages">
        <div class="bubble" [class.user]="m.role==='user'">
          <div class="role">{{ m.role }}</div>
          <div class="content">{{ m.content }}</div>
        </div>
      </div>
      <div #bottom></div>
    </div>

    <div class="composer">
      <input [(ngModel)]="input" (keydown.enter)="send()" placeholder="Message…" />
      <button type="button" (click)="send()" [disabled]="sending || !input.trim()">
        {{ sending ? "Sending…" : "Send" }}
      </button>
    </div>
  </section>
</div>
